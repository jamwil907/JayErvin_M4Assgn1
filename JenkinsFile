pipeline {
    agent any

    options {
        timeout(time: 60, unit: 'SECONDS')
        buildDiscarder(logRotator(daysToKeepStr: '7', numToKeepStr: '10'))
        timestamps()
    }

    triggers {
        cron('0 8 * * *')
    }

    environment {
        MONITOR_URL = "${JENKINS_URL}monitoring"
    }

    stages {

        stage('Initialize Workspace') {
            steps {
                cleanWs()
                sh 'mkdir -p logs'
                sh 'echo "Pipeline started at $(date)" > logs/pipeline.log'
            }
        }

        stage('Checkout') {
            steps {
                git 'https://github.com/jamwil907/JayErvin_M4Assgn1.git'
                sh 'echo "Checkout completed at $(date)" >> logs/pipeline.log'
            }
        }

        stage('Monitoring Info') {
            steps {
                echo "üìä Jenkins Monitoring Dashboard: ${MONITOR_URL}"
                sh 'echo "Monitoring info displayed at $(date)" >> logs/pipeline.log'
            }
        }

        stage('Shell Script Dependency Check') {
            steps {
                script { startStage('Shell Script Dependency Check') }
                sh '''
                    echo "Checking .sh file dependencies..."
                    if [ -f build-container.sh ]; then
                        echo "Found build-container.sh"
                        if [ ! -x build-container.sh ]; then chmod +x build-container.sh; fi
                        bash -n build-container.sh || { echo "Syntax error in build-container.sh"; exit 1; }
                        echo "Shell script dependency check passed."
                        echo "Shell script check passed at $(date)" >> logs/pipeline.log
                    else
                        echo "ERROR: build-container.sh not found!"
                        exit 1
                    fi
                '''
                script { endStage('Shell Script Dependency Check') }
            }
        }

        stage('Security Checks') {
            steps {
                script { startStage('Security Checks') }
                sh '''
                    echo "=== Security Checks Stage ==="
                    if command -v composer >/dev/null 2>&1; then
                        composer audit || true
                        echo "Composer audit run at $(date)" >> logs/pipeline.log
                    else
                        echo "Composer not available, skipping security checks"
                        echo "Composer not found at $(date)" >> logs/pipeline.log
                    fi
                '''
                script { endStage('Security Checks') }
            }
        }

        stage('Static Analysis (PHP Lint)') {
            steps {
                script { startStage('Static Analysis') }
                sh '''
                    echo "Running PHP lint checks..."
                    if ls *.php >/dev/null 2>&1; then
                        for file in *.php; do
                            echo "Linting $file"
                            php -l "$file" || { echo "PHP syntax error in $file"; exit 1; }
                            echo "Linted $file at $(date)" >> logs/pipeline.log
                        done
                    else
                        echo "No PHP files found to lint."
                        echo "No PHP files found at $(date)" >> logs/pipeline.log
                    fi
                '''
                script { endStage('Static Analysis') }
            }
        }

        stage('Test Build Script') {
            steps {
                script { startStage('Test Build Script') }
                sh '''
                    echo "Testing build-container.sh..."
                    if [ ! -f build-container.sh ]; then exit 1; fi
                    if [ ! -x build-container.sh ]; then chmod +x build-container.sh; fi
                    bash -n build-container.sh || { echo "Syntax error"; exit 1; }
                    bash build-container.sh || { echo "Build failed"; exit 1; }
                    echo "Build script tested at $(date)" >> logs/pipeline.log
                '''
                script { endStage('Test Build Script') }
            }
        }

        stage('Deliver') {
            steps {
                script { startStage('Deliver') }
                sh 'echo "Package delivery done at $(date)" >> logs/pipeline.log'
                script { endStage('Deliver') }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check the logs for errors."
        }
        always {
            echo "Module 6 Enhancement tests."
            archiveArtifacts artifacts: 'logs/**/*.log', allowEmptyArchive: true
            echo "Total build duration: ${currentBuild.durationString}"
            echo "System Metrics snapshot: ${MONITOR_URL}/metrics"
        }
    }
}

/*******************************************************
  Shared timing functions for monitoring pipeline stages
********************************************************/
def stageStartTime = 0

def startStage(name) {
    stageStartTime = System.currentTimeMillis()
    echo "‚è± Starting stage: ${name}"
}

def endStage(name) {
    def elapsed = (System.currentTimeMillis() - stageStartTime) / 1000
    echo "‚è± Stage '${name}' completed in ${elapsed} seconds"
}
