pipeline {
    agent any

    options {
        timeout(time: 60, unit: 'SECONDS')
        buildDiscarder(logRotator(daysToKeepStr: '7', numToKeepStr: '10'))
        timestamps()
    }

    triggers {
        cron('0 8 * * *')
    }

    environment {
        MONITOR_URL = "${JENKINS_URL}monitoring"
    }

    stages {

        stage('Initialize Workspace') {
            steps {
                cleanWs()
                sh 'mkdir -p logs'
                sh 'echo "Pipeline started at $(date)" > logs/pipeline.log'
            }
        }

        stage('Checkout') {
            steps {
                git 'https://github.com/jamwil907/JayErvin_M4Assgn1.git'
                sh 'echo "Checkout completed at $(date)" >> logs/pipeline.log'
            }
        }

        stage('Monitoring Info') {
            steps {
                echo "ðŸ“Š Jenkins Monitoring Dashboard: ${MONITOR_URL}"
                sh 'echo "Monitoring info displayed at $(date)" >> logs/pipeline.log'
            }
        }

        stage('Shell Script Dependency Check') {
            steps {
                script { startStage('Shell Script Dependency Check') }
                sh '''
                    echo "Checking .sh file dependencies..."
                    if [ -f build-container.sh ]; then
                        echo "Found build-container.sh"
                        if [ ! -x build-container.sh ]; then chmod +x build-container.sh; fi
                        bash -n build-container.sh || { echo "Syntax error in build-container.sh"; exit 1; }
                        echo "Shell script dependency check passed."
                        echo "Shell script check passed at $(date)" >> logs/pipeline.log
                    else
                        echo "ERROR: build-container.sh not found!"
                        exit 1
                    fi
                '''
                script { endStage('Shell Script Dependency Check') }
            }
        }

        stage('Security Checks') {
            steps {
                script { startStage('Security Checks') }
                sh '''
                    echo "=== Security Checks Stage ==="
                    if command -v composer >/dev/null 2>&1; then
                        composer audit || true
                        echo "Composer audit run at $(date)" >> logs/pipeline.log
                    else
                        echo "Composer not available, skipping security checks"
                        echo "Composer not found at $(date)" >> logs/pipeline.log
                    fi
                '''
                script { endStage('Security Checks') }
            }
        }

        stage('Static Analysis (PHP Lint)') {
            steps {
                script { startStage('Static Analysis') }
                sh '''
                    echo "Running PHP lint checks..."
                    if ls *.php >/dev/null 2>&1; then
                        for file in *.php; do
                            echo "Linting $file"
                            php -l "$file" || { echo "PHP syntax error in $file"; exit 1; }
                            echo "Linted $file at $(date)" >>
